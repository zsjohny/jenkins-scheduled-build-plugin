# 安装使用指南

## 🚀 安装步骤

### 1. 安装插件

#### 方式 A：通过 Jenkins Web 界面（推荐）

1. 登录 Jenkins
2. 点击左侧菜单 **"系统管理"** (Manage Jenkins)
3. 点击 **"插件管理"** (Manage Plugins)
4. 切换到 **"高级"** (Advanced) 标签页
5. 在 **"上传插件"** (Upload Plugin) 部分：
   - 点击 **"选择文件"**
   - 选择 `target/scheduled-build.hpi` 文件
   - 点击 **"上传"** (Upload)
6. 等待上传完成后，**重启 Jenkins**

#### 方式 B：手动复制文件

```bash
# 复制插件到 Jenkins 插件目录
cp target/scheduled-build.hpi $JENKINS_HOME/plugins/

# 重启 Jenkins
# 如果使用 systemd
sudo systemctl restart jenkins

# 如果使用 Docker
docker restart jenkins
```

### 2. 验证安装

重启 Jenkins 后，验证插件是否安装成功：

1. 进入 **"系统管理"** → **"插件管理"** → **"已安装"**
2. 搜索 **"Scheduled Build Plugin"**
3. 确认状态为 **"已启用"** ✅

## ✨ 使用方法

### 插件自动启用

**🎉 新版本改进：** 插件安装后，**所有任务都会自动显示预约构建功能**，无需额外配置！

### 查看预约构建入口

1. 打开任何 Jenkins 任务（Job）页面
2. 在左侧菜单中会自动出现 **"预约构建"** (Scheduled Builds) 链接 ⏰
3. 点击即可管理该任务的所有预约

### 添加预约构建

1. 进入任务页面 → 点击 **"预约构建"**
2. 在页面上方找到 **"添加新预约"** 表单
3. 填写以下信息：
   - **预约时间**：选择未来的日期和时间
   - **描述**（可选）：说明此次预约的目的
   - **构建参数**（如果任务是参数化构建）：设置各个参数的值
4. 点击 **"添加预约"** 按钮
5. 成功后会在列表中看到新添加的预约

### 管理预约

在预约列表中，每个预约会显示：

- ⏰ **预约时间**：格式化的日期时间
- 📝 **描述**：预约说明
- 📊 **状态**：
  - 🟡 **待执行** (Pending) - 等待执行
  - ✅ **已执行** (Executed) - 已成功触发
  - ❌ **已取消** (Cancelled) - 被手动取消
  - ⏱️ **相对时间**：距离执行还有多久（如"2小时后"）
- 🎯 **操作按钮**：
  - **取消** - 取消待执行的预约
  - **删除** - 删除历史记录

### 参数化构建支持

如果您的任务配置了参数（Parameters），预约构建表单会自动显示所有参数：

- ✏️ 每个参数都有对应的输入框
- 🔢 使用默认值或自定义值
- 💾 每个预约可以有不同的参数组合

## 📊 功能特性

### ✅ 主要功能

1. **多任务预约**
   - 同一任务可以设置多个预约
   - 每个预约独立管理

2. **参数化支持**
   - 自动识别任务参数
   - 每个预约使用不同参数值

3. **状态追踪**
   - 实时显示预约状态
   - 相对时间提示（"2小时后"）

4. **灵活管理**
   - 随时取消未执行的预约
   - 删除历史记录保持整洁

5. **持久化存储**
   - 预约信息永久保存
   - Jenkins 重启后自动恢复

6. **自动执行**
   - 到达预约时间自动触发构建
   - 记录执行历史

### 🔒 权限要求

使用预约构建功能需要以下权限：

- **查看预约列表**：需要任务的 `READ` 权限
- **添加/取消预约**：需要任务的 `BUILD` 权限

## 🎯 使用场景

### 场景 1：定期发版
```
任务：production-deploy
预约时间：每周五 18:00
参数：version=v1.2.3, environment=production
描述：周五晚上生产环境发版
```

### 场景 2：夜间测试
```
任务：integration-test
预约时间：今晚 23:00
参数：test_suite=full, parallel=8
描述：夜间完整回归测试
```

### 场景 3：临时任务
```
任务：data-migration
预约时间：明天上午 10:00
参数：batch_size=1000, dry_run=false
描述：数据库迁移任务
```

## ❓ 常见问题

### Q1: 安装后看不到预约构建菜单？

**A:** 新版本插件会自动为所有任务添加预约构建功能。如果看不到，请检查：

1. 插件是否正确安装（在"已安装插件"中查看）
2. Jenkins 是否已重启
3. 浏览器缓存是否需要清除（Ctrl+F5）
4. 是否有任务的访问权限

### Q2: 如何设置重复的定期任务？

**A:** 预约构建是一次性的。如果需要周期性执行，可以：

- 使用 Jenkins 自带的"构建触发器" → "定时构建"
- 或者每次执行后手动添加下一次预约

### Q3: 预约时间到了但没有执行？

**A:** 请检查：

1. Jenkins 服务器时区设置是否正确
2. 预约是否被取消
3. Jenkins 服务是否在预约时间运行
4. 查看 Jenkins 日志是否有错误信息

### Q4: 可以修改已有的预约吗？

**A:** 当前版本不支持直接修改。需要：

1. 取消原有预约
2. 添加新的预约

### Q5: 预约执行失败怎么办？

**A:** 预约功能只负责触发构建，构建本身的成功失败取决于任务配置。请：

1. 在构建历史中查看失败原因
2. 检查任务配置和参数是否正确

### Q6: 可以导出预约列表吗？

**A:** 当前版本不支持导出。预约信息存储在 `$JENKINS_HOME/io.jenkins.plugins.scheduledbuild.ScheduledBuildManager.xml`

## 🔄 升级指南

从旧版本升级到新版本：

1. **备份数据**（可选但推荐）
   ```bash
   cp $JENKINS_HOME/io.jenkins.plugins.scheduledbuild.ScheduledBuildManager.xml \
      $JENKINS_HOME/io.jenkins.plugins.scheduledbuild.ScheduledBuildManager.xml.backup
   ```

2. **上传新版本插件**
   - 按照上面的安装步骤上传新的 `.hpi` 文件
   - Jenkins 会自动覆盖旧版本

3. **重启 Jenkins**

4. **验证功能**
   - 检查已有预约是否保留
   - 测试新增预约功能

## 📝 注意事项

1. ⏰ **时区问题**：确保 Jenkins 服务器时区设置正确
2. 🔒 **权限管理**：确保用户有 BUILD 权限才能添加预约
3. 💾 **定期清理**：建议定期删除旧的执行记录
4. 🔄 **Jenkins 重启**：重启不会丢失预约，会自动恢复
5. ⚡ **服务器关闭**：如果预约时间内服务器关闭，预约会过期

## 📞 支持

如有问题，请：

1. 查看 Jenkins 日志：`$JENKINS_HOME/logs/`
2. 提交 GitHub Issue
3. 查看项目文档：`README.md` 和 `COMPATIBILITY.md`

---

**祝您使用愉快！** 🎉

