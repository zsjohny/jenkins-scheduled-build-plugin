# Jenkins 预约构建插件 - 使用指南

## 快速开始

### 第一步：安装插件

1. 构建插件：
```bash
mvn clean package
```

2. 在Jenkins中安装生成的 `target/scheduled-build.hpi` 文件

3. 重启Jenkins

### 第二步：为任务启用预约构建功能

1. 打开Jenkins任务配置页面
2. 向下滚动找到"启用预约构建"选项
3. 勾选该选项
4. 保存配置

![启用预约构建](docs/enable-scheduled-build.png)

### 第三步：添加预约

1. 进入任务主页
2. 点击左侧菜单的"预约构建"
3. 填写预约信息：
   - **预约时间**：选择具体的日期和时间
   - **描述**：填写预约说明（可选）
   - **参数**：如果任务支持参数化构建，设置每个参数的值

![添加预约](docs/add-schedule.png)

## 详细功能说明

### 1. 添加预约构建

预约构建支持以下配置项：

#### 时间选择
- 使用日期时间选择器选择未来的任意时间点
- 最小精度为分钟
- 不支持选择过去的时间

#### 描述信息
- 可选字段，用于说明这次预约的目的
- 例如："生产环境发布 v2.0"、"周末性能测试"等
- 会显示在预约列表中

#### 构建参数
- 如果任务配置了参数化构建，会自动显示所有参数
- 支持的参数类型：
  - **字符串参数**：可以输入任意文本
  - **布尔参数**：勾选框，表示true/false
  - **选择参数**：下拉列表，从预定义选项中选择
- 会使用参数的默认值作为初始值
- 每个预约可以设置不同的参数值

### 2. 查看预约列表

预约构建页面分为两个区域：

#### 待执行的预约
- 显示所有尚未执行的预约
- 包含倒计时信息，实时显示距离执行还有多长时间
- 可以取消这些预约

#### 所有预约记录
- 显示所有预约的历史记录
- 包括以下状态：
  - **✓ 已执行**：绿色，预约已成功触发构建
  - **⏳ 待执行**：蓝色，等待执行中
  - **✗ 已取消**：红色，用户主动取消的预约
  - **⚠ 已过期**：橙色，预约时间已过但未执行（如Jenkins关闭）

### 3. 取消预约

对于待执行的预约：
1. 在预约列表中找到要取消的预约
2. 点击"取消"按钮
3. 预约状态会变更为"已取消"
4. 不会触发构建

**注意**：只能取消待执行的预约，已执行或已取消的预约无法再次操作。

### 4. 删除预约记录

对于任何状态的预约记录：
1. 点击"删除记录"按钮
2. 该预约会从系统中永久删除
3. 此操作不可恢复

**建议**：定期清理不需要的历史记录，保持列表整洁。

### 5. 预约执行

当到达预约时间时：
1. 插件会自动触发Jenkins构建
2. 使用预约时设置的参数值
3. 在构建历史中，触发原因会显示"预约构建"
4. 预约状态更新为"已执行"

## 使用场景示例

### 场景1：周五晚上发布生产环境

**需求**：每周五下班后18:30发布到生产环境

**操作步骤**：
1. 进入"生产部署"任务的预约构建页面
2. 添加预约：
   - 时间：本周五 18:30
   - 描述：周末生产发布
   - 参数：
     - ENVIRONMENT=production
     - BRANCH=release/v1.5
     - ENABLE_BACKUP=true
     - NOTIFY_TEAM=true
3. 点击"添加预约"

**结果**：周五18:30会自动触发构建，使用指定参数部署到生产环境。

### 场景2：多阶段夜间测试

**需求**：晚上进行三轮不同的自动化测试

**操作步骤**：

**预约1 - 冒烟测试**
- 时间：今晚 22:00
- 描述：快速冒烟测试
- 参数：TEST_SUITE=smoke

**预约2 - 回归测试**
- 时间：今晚 23:00  
- 描述：完整回归测试
- 参数：TEST_SUITE=regression

**预约3 - 性能测试**
- 时间：明早 03:00
- 描述：性能基准测试
- 参数：TEST_SUITE=performance, DURATION=2h

**结果**：三个测试会按时间顺序自动执行，早上来就能看到所有结果。

### 场景3：定时数据处理

**需求**：每月初处理上月数据

**操作步骤**：
1. 在"数据处理"任务中添加预约
2. 设置：
   - 时间：2024-02-01 08:00
   - 描述：处理1月份数据
   - 参数：
     - START_DATE=2024-01-01
     - END_DATE=2024-01-31
     - OUTPUT_FORMAT=excel
     - NOTIFY_EMAIL=team@company.com

**结果**：2月1日早上8点自动处理1月数据并发送邮件通知。

### 场景4：提前预约版本构建

**需求**：提前三天预约发布日的构建

**操作步骤**：
1. 提前规划发布时间
2. 添加预约：
   - 时间：2024-02-15 14:00（发布日下午2点）
   - 描述：Q1版本正式发布
   - 参数：
     - VERSION=2.0.0
     - CHANGELOG=true
     - CREATE_TAG=true

**结果**：不用在发布当天操心，到时间自动构建。

## 高级技巧

### 技巧1：批量预约时间段测试

如果需要测试某个功能在不同时间的行为，可以设置多个预约：

```
预约1: 明天 00:00 - 参数 TIME_SLOT=midnight
预约2: 明天 06:00 - 参数 TIME_SLOT=morning
预约3: 明天 12:00 - 参数 TIME_SLOT=noon
预约4: 明天 18:00 - 参数 TIME_SLOT=evening
```

### 技巧2：预约+邮件通知

结合Jenkins的邮件插件，在预约的参数中设置通知邮箱：

```
参数：
- NOTIFY_EMAIL=manager@company.com
- NOTIFY_ON_SUCCESS=true
- NOTIFY_ON_FAILURE=true
```

### 技巧3：利用描述字段记录预约原因

养成填写描述的习惯，方便后续查看：

```
描述示例：
- "修复Bug #1234后的验证构建"
- "客户要求的周六演示版本"
- "性能优化后的基准测试"
```

### 技巧4：定期清理历史记录

建议每月清理一次已执行或已取消的历史预约：
1. 浏览预约列表
2. 对于已完成且不再需要的记录，点击"删除记录"
3. 保持列表整洁，便于管理

## 权限管理

插件遵循Jenkins的权限体系：

- **查看预约列表**：需要 `Job.READ` 权限
- **添加预约**：需要 `Job.BUILD` 权限  
- **取消预约**：需要 `Job.BUILD` 权限
- **删除记录**：需要 `Job.BUILD` 权限

如果没有相应权限，对应功能会不可见或不可操作。

## 常见问题解答

### Q1: 如何确认预约已添加成功？

**A**: 添加后会立即显示在"待执行的预约"列表中，并显示倒计时。

### Q2: 预约时间可以修改吗？

**A**: 当前版本不支持修改。如需变更，请取消原预约并重新添加。

### Q3: 如果同时有多个预约，会冲突吗？

**A**: 不会冲突。每个预约独立触发构建，会按时间依次执行（如果构建排队，会在队列中等待）。

### Q4: 预约的构建会占用构建节点吗？

**A**: 会的。预约触发的构建和手动触发的构建完全一样，都需要等待可用的构建节点。

### Q5: Jenkins重启会影响预约吗？

**A**: 不会。所有预约都持久化保存，重启后会自动恢复并继续等待执行。

### Q6: 预约时间已过但Jenkins当时关闭，会补执行吗？

**A**: 不会自动补执行。该预约会标记为"已过期"，需要手动重新添加预约。

### Q7: 可以看到预约是谁添加的吗？

**A**: 当前版本不记录添加人信息。建议在描述中注明。

### Q8: 支持循环预约吗（每天/每周）？

**A**: 不支持。本插件专注于"一次性"预约。循环任务请使用Jenkins内置的"构建触发器" - "定时构建"功能。

### Q9: 如何监控预约执行情况？

**A**: 
1. 在预约列表中查看状态变化
2. 在构建历史中查看构建记录
3. 构建详情中会显示"预约构建"作为触发原因

### Q10: 可以通过API添加预约吗？

**A**: 可以通过Jenkins REST API调用插件接口。具体请参考开发文档。

## 故障排查

### 问题1：预约列表为空

**可能原因**：
- 任务未启用预约构建功能
- 没有查看权限

**解决方法**：
1. 检查任务配置，确认勾选了"启用预约构建"
2. 确认当前用户有 `Job.READ` 权限

### 问题2：无法添加预约

**可能原因**：
- 选择了过去的时间
- 没有 `Job.BUILD` 权限
- 参数填写错误

**解决方法**：
1. 确保选择未来的时间
2. 检查用户权限
3. 检查必填参数是否都已填写

### 问题3：预约到时间没有执行

**可能原因**：
- Jenkins当时处于关闭状态
- 所有构建节点都被占用，任务在队列中等待
- 预约被取消

**解决方法**：
1. 检查Jenkins运行日志
2. 查看构建队列是否有该任务
3. 查看预约状态是否为"已取消"

### 问题4：预约执行了但参数不对

**可能原因**：
- 添加预约时参数设置错误
- 任务的参数定义发生了变化

**解决方法**：
1. 在添加预约前仔细检查参数值
2. 如果任务参数定义变化，重新添加预约

## 最佳实践

1. **提前预约**：重要构建建议提前1天以上预约，避免临时调整
2. **填写描述**：养成填写描述的习惯，方便追溯
3. **验证参数**：添加预约前，先手动运行一次确认参数正确
4. **定期清理**：每月清理已完成的历史记录
5. **监控执行**：重要预约建议在执行时间附近关注执行情况
6. **测试先行**：在生产环境预约前，先在测试环境验证
7. **备份方案**：关键发布建议保留手动执行的备选方案
8. **团队协作**：在描述中注明预约人和目的，方便团队协作

## 技术支持

如有问题，请通过以下方式获取帮助：
- 提交GitHub Issue
- 查看Jenkins日志文件
- 联系开发团队

---

**祝使用愉快！**



