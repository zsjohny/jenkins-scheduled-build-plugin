<?jelly escape-by-default='true'?>
<j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:l="/lib/layout" xmlns:f="/lib/form">
    <l:layout title="é¢„çº¦æ„å»º - ${it.job.displayName}" permission="${it.job.READ}">
        <st:include page="sidepanel.jelly" it="${it.job}"/>
        <l:main-panel>
            <style>
                .scheduled-build-container {
                    max-width: 1200px;
                }
                .scheduled-build-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 8px;
                    margin-bottom: 30px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                }
                .scheduled-build-header h1 {
                    margin: 0;
                    color: white;
                    font-size: 28px;
                    font-weight: 600;
                }
                .add-schedule-card {
                    background: white;
                    padding: 25px;
                    margin-bottom: 30px;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    border: 1px solid #e0e0e0;
                }
                .add-schedule-card h2 {
                    margin-top: 0;
                    color: #333;
                    font-size: 20px;
                    font-weight: 600;
                    border-bottom: 2px solid #667eea;
                    padding-bottom: 10px;
                    margin-bottom: 20px;
                }
                .form-row {
                    margin-bottom: 20px;
                }
                .form-label {
                    display: block;
                    font-weight: 600;
                    color: #555;
                    margin-bottom: 8px;
                    font-size: 14px;
                }
                /* ä¿æŒ Jenkins åŸç”Ÿæ ·å¼ï¼Œåªæ·»åŠ å¿…è¦çš„è‡ªå®šä¹‰æ ·å¼ */
                .scheduled-build-container .form-section {
                    margin-top: 20px;
                }
                
                /* ç¡®ä¿å‚æ•°éƒ¨åˆ†æœ‰é€‚å½“çš„é—´è· */
                .scheduled-build-container .form-section h3 {
                    margin-top: 0;
                    margin-bottom: 15px;
                    color: #333;
                    font-size: 16px;
                    font-weight: 600;
                }
                
                /* å‚æ•°æ ‡ç­¾æ ·å¼ */
                .scheduled-build-container .form-label {
                    font-weight: bold !important;
                    color: #333 !important;
                    font-size: 14px !important;
                }
                
                /* å‚æ•°æè¿°æ ·å¼ */
                .scheduled-build-container .form-description {
                    color: #666 !important;
                    font-size: 12px !important;
                    font-style: italic !important;
                }
                
                /* å¿…å¡«å‚æ•°æ ·å¼ */
                .scheduled-build-container .form-label[required] {
                    color: #d73527 !important;
                }
                
                /* å‚æ•°è¾“å…¥æ¡†æ ·å¼ */
                .scheduled-build-container .form-input,
                .scheduled-build-container .form-textarea,
                .scheduled-build-container .form-select {
                    border: 1px solid #ccc !important;
                    border-radius: 4px !important;
                    padding: 8px !important;
                    font-size: 14px !important;
                }
                
                /* å‚æ•°è¾“å…¥æ¡†ç„¦ç‚¹æ ·å¼ */
                .scheduled-build-container .form-input:focus,
                .scheduled-build-container .form-textarea:focus,
                .scheduled-build-container .form-select:focus {
                    border-color: #4a90e2 !important;
                    box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2) !important;
                }
                
                /* è‡ªå®šä¹‰æŒ‰é’®æ ·å¼ */
                .btn-primary {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px 30px;
                    font-size: 15px;
                    font-weight: 600;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.3s;
                    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
                }
                .btn-primary:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
                }
                .btn-primary {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px 30px;
                    font-size: 15px;
                    font-weight: 600;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.3s;
                    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
                }
                .btn-primary:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
                }
                .btn-danger {
                    background: #dc3545;
                    color: white;
                    padding: 6px 14px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 13px;
                    transition: background 0.3s;
                }
                .btn-danger:hover {
                    background: #c82333;
                }
                .btn-secondary {
                    background: #6c757d;
                    color: white;
                    padding: 6px 14px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 13px;
                    transition: background 0.3s;
                }
                .btn-secondary:hover {
                    background: #5a6268;
                }
                .schedule-list-card {
                    background: white;
                    padding: 25px;
                    margin-bottom: 30px;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    border: 1px solid #e0e0e0;
                }
                .schedule-list-card h2 {
                    margin-top: 0;
                    color: #333;
                    font-size: 20px;
                    font-weight: 600;
                    margin-bottom: 20px;
                }
                .schedule-count {
                    background: #667eea;
                    color: white;
                    padding: 2px 10px;
                    border-radius: 12px;
                    font-size: 14px;
                    font-weight: 600;
                    margin-left: 10px;
                }
                .no-data {
                    text-align: center;
                    padding: 40px;
                    color: #999;
                    font-size: 14px;
                }
                .status-badge {
                    padding: 4px 12px;
                    border-radius: 12px;
                    font-size: 12px;
                    font-weight: 600;
                    display: inline-block;
                }
                .status-executed {
                    background: #d4edda;
                    color: #155724;
                }
                .status-cancelled {
                    background: #f8d7da;
                    color: #721c24;
                }
                .status-pending {
                    background: #d1ecf1;
                    color: #0c5460;
                }
                .status-expired {
                    background: #fff3cd;
                    color: #856404;
                }
                .countdown {
                    font-weight: 600;
                    color: #667eea;
                    font-family: 'Courier New', monospace;
                }
                .param-display {
                    background: #f8f9fa;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                    color: #495057;
                    border: 1px solid #e9ecef;
                }
                .checkbox-wrapper {
                    display: flex;
                    align-items: center;
                }
                .checkbox-wrapper input[type="checkbox"] {
                    width: 18px;
                    height: 18px;
                    margin-right: 8px;
                    cursor: pointer;
                }
            </style>
            
            <script type="text/javascript">
                // åŠ¨æ€å€’è®¡æ—¶æ›´æ–°
                function updateCountdowns() {
                    var countdowns = document.querySelectorAll('.countdown');
                    countdowns.forEach(function(elem) {
                        var targetTime = parseInt(elem.getAttribute('data-target'));
                        if (!targetTime) return;
                        
                        var now = new Date().getTime();
                        var diff = targetTime - now;
                        
                        if (diff &lt;= 0) {
                            elem.textContent = 'å³å°†æ‰§è¡Œ...';
                            elem.style.color = '#dc3545';
                            return;
                        }
                        
                        var days = Math.floor(diff / (1000 * 60 * 60 * 24));
                        var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        var seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        var result = '';
                        if (days > 0) result += days + 'å¤© ';
                        if (hours > 0 || days > 0) result += hours + 'å°æ—¶ ';
                        if (minutes > 0 || hours > 0 || days > 0) result += minutes + 'åˆ† ';
                        result += seconds + 'ç§’';
                        
                        elem.textContent = result;
                        
                        // æ ¹æ®å‰©ä½™æ—¶é—´æ”¹å˜é¢œè‰²
                        if (diff &lt; 300000) { // å°äº5åˆ†é’Ÿ
                            elem.style.color = '#dc3545';
                        } else if (diff &lt; 3600000) { // å°äº1å°æ—¶
                            elem.style.color = '#fd7e14';
                        } else {
                            elem.style.color = '#667eea';
                        }
                    });
                }
                
                // å°† datetime-local è¾“å…¥è½¬æ¢ä¸º Jenkins æœŸæœ›çš„æ ¼å¼
                function setupDateTimeInput() {
                    var scheduledTimeInput = document.querySelector('input[name="scheduledTime"]');
                    if (scheduledTimeInput) {
                        // åˆ›å»º datetime-local è¾“å…¥
                        var datetimeInput = document.createElement('input');
                        datetimeInput.type = 'datetime-local';
                        datetimeInput.name = 'scheduledTime';
                        datetimeInput.required = true;
                        datetimeInput.style.width = '100%';
                        datetimeInput.style.padding = '8px';
                        datetimeInput.style.border = '1px solid #ccc';
                        datetimeInput.style.borderRadius = '4px';
                        
                        // è®¾ç½®é»˜è®¤å€¼ä¸ºå½“å‰æ—¶é—´å1å°æ—¶
                        var now = new Date();
                        now.setHours(now.getHours() + 1);
                        var year = now.getFullYear();
                        var month = String(now.getMonth() + 1).padStart(2, '0');
                        var day = String(now.getDate()).padStart(2, '0');
                        var hours = String(now.getHours()).padStart(2, '0');
                        var minutes = String(now.getMinutes()).padStart(2, '0');
                        datetimeInput.value = year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
                        
                        // æ›¿æ¢åŸå§‹è¾“å…¥
                        scheduledTimeInput.parentNode.replaceChild(datetimeInput, scheduledTimeInput);
                        
                        // åœ¨è¡¨å•æäº¤æ—¶è½¬æ¢æ ¼å¼
                        var form = datetimeInput.closest('form');
                        if (form) {
                            form.addEventListener('submit', function(e) {
                                var datetimeValue = datetimeInput.value;
                                if (datetimeValue) {
                                    // è½¬æ¢ä¸º Jenkins æœŸæœ›çš„æ ¼å¼ (yyyy-MM-dd'T'HH:mm)
                                    var hiddenInput = document.createElement('input');
                                    hiddenInput.type = 'hidden';
                                    hiddenInput.name = 'scheduledTime';
                                    hiddenInput.value = datetimeValue;
                                    form.appendChild(hiddenInput);
                                }
                            });
                        }
                    }
                }
                
                // åˆå§‹åŒ–å‚æ•°æ¸²æŸ“
                function initializeParameterRendering() {
                    // ç¡®ä¿ Jenkins è¡¨å•ç»„ä»¶æ­£ç¡®åˆå§‹åŒ–
                    if (typeof Behaviour !== 'undefined') {
                        Behaviour.applySubtree(document);
                    }
                    
                    // ä¸ºå‚æ•°æ·»åŠ å¿…è¦çš„æ ·å¼å’ŒåŠŸèƒ½
                    var paramEntries = document.querySelectorAll('.scheduled-build-container .form-section .form-entry');
                    paramEntries.forEach(function(entry) {
                        var title = entry.querySelector('.form-label');
                        if (title) {
                            // ç¡®ä¿æ ‡é¢˜æœ‰æ­£ç¡®çš„æ ·å¼
                            title.style.fontWeight = 'bold';
                            title.style.color = '#333';
                        }
                        
                        // ä¸ºå¿…å¡«å‚æ•°æ·»åŠ çº¢è‰²æ˜Ÿå·
                        var required = entry.querySelector('.form-label[required]');
                        if (required) {
                            var asterisk = document.createElement('span');
                            asterisk.innerHTML = ' <span style="color:red"><strong>ã€å¿…å¡«ã€‘</strong></span>';
                            required.appendChild(asterisk);
                        }
                    });
                }
                
                // é¡µé¢åŠ è½½åç«‹å³æ›´æ–°ä¸€æ¬¡
                window.addEventListener('DOMContentLoaded', function() {
                    updateCountdowns();
                    setupDateTimeInput();
                    initializeParameterRendering();
                    // æ¯ç§’æ›´æ–°ä¸€æ¬¡
                    setInterval(updateCountdowns, 1000);
                });
            </script>
            
            <div class="scheduled-build-container">
                <div class="scheduled-build-header">
                    <h1>â° é¢„çº¦æ„å»ºç®¡ç†</h1>
                </div>
            
            <!-- æ·»åŠ æ–°é¢„çº¦è¡¨å• -->
                <div class="add-schedule-card">
                    <h2>ğŸ“ æ·»åŠ æ–°é¢„çº¦</h2>
                    <f:form method="post" action="schedule">
                        <f:entry title="ğŸ“… é¢„çº¦æ—¶é—´" description="é€‰æ‹©æ„å»ºæ‰§è¡Œçš„æ—¥æœŸå’Œæ—¶é—´">
                            <f:textbox name="scheduledTime" 
                                       value=""
                                       checkUrl="'checkTime'"
                                       checkMethod="post"/>
                        </f:entry>
                        
                        <f:entry title="ğŸ“„ æè¿°" description="ä¸ºè¿™æ¬¡é¢„çº¦æ·»åŠ è¯´æ˜ï¼Œæ–¹ä¾¿åç»­è¯†åˆ«">
                            <f:textbox name="description" 
                                       value=""
                                       placeholder="é¢„çº¦è¯´æ˜ï¼ˆå¯é€‰ï¼‰"/>
                        </f:entry>
                        
                        <!-- å‚æ•° -->
                        <j:if test="${!it.jobParameters.isEmpty()}">
                            <f:section title="ğŸ”§ æ„å»ºå‚æ•°">
                                <j:forEach var="param" items="${it.jobParameters}">
                                    <f:entry title="${param.name}" description="${param.description}">
                                        <j:choose>
                                            <j:when test="${param.class.simpleName == 'BooleanParameterDefinition'}">
                                                <f:checkbox name="param_${param.name}" 
                                                           checked="${param.defaultParameterValue.value}"
                                                           value="true"/>
                                            </j:when>
                                            <j:when test="${param.class.simpleName == 'ChoiceParameterDefinition'}">
                                                <f:select name="param_${param.name}">
                                                    <j:forEach var="choice" items="${param.choices}">
                                                        <f:option value="${choice}" selected="${choice == param.defaultParameterValue.value}">${choice}</f:option>
                                                    </j:forEach>
                                                </f:select>
                                            </j:when>
                                            <j:when test="${param.class.simpleName == 'TextParameterDefinition'}">
                                                <f:textarea name="param_${param.name}" 
                                                           value="${param.defaultParameterValue.value}"
                                                           rows="3"/>
                                            </j:when>
                                            <j:when test="${param.class.simpleName == 'PasswordParameterDefinition'}">
                                                <f:password name="param_${param.name}" 
                                                           value="${param.defaultParameterValue.value}"/>
                                            </j:when>
                                            <j:otherwise>
                                                <f:textbox name="param_${param.name}" 
                                                          value="${param.defaultParameterValue.value}"/>
                                            </j:otherwise>
                                        </j:choose>
                                    </f:entry>
                                </j:forEach>
                            </f:section>
                        </j:if>
                        
                        <f:block>
                            <f:submit value="âœ“ æ·»åŠ é¢„çº¦" class="btn-primary"/>
                        </f:block>
                    </f:form>
                </div>

            <!-- å¾…æ‰§è¡Œçš„é¢„çº¦ -->
                <div class="schedule-list-card">
                    <h2>
                        ğŸš€ å¾…æ‰§è¡Œçš„é¢„çº¦
                        <span class="schedule-count">${it.pendingBuilds.size()}</span>
                    </h2>
            <j:choose>
                <j:when test="${it.pendingBuilds.isEmpty()}">
                            <div class="no-data">
                                ğŸ“­ æš‚æ— å¾…æ‰§è¡Œçš„é¢„çº¦
                            </div>
                </j:when>
                <j:otherwise>
                    <table class="sortable pane bigtable" style="width: 100%; margin-top: 10px;">
                        <thead>
                            <tr>
                                        <th style="width: 180px;">é¢„çº¦æ—¶é—´</th>
                                        <th style="width: 150px;">â±ï¸ å€’è®¡æ—¶</th>
                                <th>æè¿°</th>
                                        <th style="width: 200px;">å‚æ•°</th>
                                        <th style="width: 100px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <j:forEach var="task" items="${it.pendingBuilds}">
                                <tr>
                                    <td>${it.formatDateTime(task.scheduledTime)}</td>
                                            <td>
                                                <span class="countdown" data-target="${task.scheduledTime}">
                                                    ${it.getRelativeTime(task.scheduledTime)}
                                                </span>
                                            </td>
                                    <td>${task.description}</td>
                                            <td>
                                                <div class="param-display">
                                        ${task.parametersString}
                                                </div>
                                    </td>
                                    <td>
                                        <form method="post" action="cancel" style="display: inline;">
                                            <input type="hidden" name="taskId" value="${task.id}"/>
                                                    <button type="submit" class="btn-danger">
                                                        âœ— å–æ¶ˆ
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            </j:forEach>
                        </tbody>
                    </table>
                </j:otherwise>
            </j:choose>
                </div>

            <!-- æ‰€æœ‰é¢„çº¦å†å² -->
                <div class="schedule-list-card">
                    <h2>
                        ğŸ“š æ‰€æœ‰é¢„çº¦è®°å½•
                        <span class="schedule-count">${it.scheduledBuilds.size()}</span>
                    </h2>
            <j:choose>
                <j:when test="${it.scheduledBuilds.isEmpty()}">
                            <div class="no-data">
                                ğŸ“­ æš‚æ— é¢„çº¦è®°å½•
                            </div>
                </j:when>
                <j:otherwise>
                    <table class="sortable pane bigtable" style="width: 100%; margin-top: 10px;">
                        <thead>
                            <tr>
                                        <th style="width: 180px;">é¢„çº¦æ—¶é—´</th>
                                        <th style="width: 120px;">çŠ¶æ€</th>
                                <th>æè¿°</th>
                                        <th style="width: 200px;">å‚æ•°</th>
                                        <th style="width: 140px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <j:forEach var="task" items="${it.scheduledBuilds}">
                                <tr>
                                    <td>${it.formatDateTime(task.scheduledTime)}</td>
                                    <td>
                                        <j:choose>
                                            <j:when test="${task.executed}">
                                                        <span class="status-badge status-executed">âœ“ å·²æ‰§è¡Œ</span>
                                            </j:when>
                                            <j:when test="${task.cancelled}">
                                                        <span class="status-badge status-cancelled">âœ— å·²å–æ¶ˆ</span>
                                            </j:when>
                                            <j:when test="${task.pending}">
                                                        <span class="status-badge status-pending">â³ å¾…æ‰§è¡Œ</span>
                                            </j:when>
                                            <j:otherwise>
                                                        <span class="status-badge status-expired">âš  å·²è¿‡æœŸ</span>
                                            </j:otherwise>
                                        </j:choose>
                                    </td>
                                    <td>${task.description}</td>
                                            <td>
                                                <div class="param-display">
                                        ${task.parametersString}
                                                </div>
                                    </td>
                                    <td>
                                        <j:if test="${task.pending}">
                                            <form method="post" action="cancel" style="display: inline; margin-right: 5px;">
                                                <input type="hidden" name="taskId" value="${task.id}"/>
                                                        <button type="submit" class="btn-danger">
                                                            âœ— å–æ¶ˆ
                                                </button>
                                            </form>
                                        </j:if>
                                        <form method="post" action="delete" style="display: inline;">
                                            <input type="hidden" name="taskId" value="${task.id}"/>
                                                    <button type="submit" class="btn-secondary">
                                                        ğŸ—‘ï¸ åˆ é™¤
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            </j:forEach>
                        </tbody>
                    </table>
                </j:otherwise>
            </j:choose>
                </div>
            </div>
        </l:main-panel>
    </l:layout>
</j:jelly>



