name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: éªŒè¯ PR
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
        
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ Java ä»£ç æ ¼å¼..."
        find src/main/java -name "*.java" | wc -l
        
    - name: ç¼–è¯‘æ£€æŸ¥
      run: mvn clean compile -DskipTests
      
    - name: ä¾èµ–æ£€æŸ¥
      run: mvn dependency:analyze
      continue-on-error: true
      
    - name: éªŒè¯æ‰©å±•ç‚¹
      run: |
        echo "æ£€æŸ¥æ‰©å±•ç‚¹æ³¨è§£..."
        grep -r "@Extension" src/main/java/ || echo "æœªæ‰¾åˆ° @Extension æ³¨è§£"
        
    - name: æ£€æŸ¥èµ„æºæ–‡ä»¶
      run: |
        if [ -f src/main/resources/META-INF/services/hudson.Extension ]; then
          echo "âœ… æ‰©å±•ç‚¹ç´¢å¼•æ–‡ä»¶å­˜åœ¨"
          cat src/main/resources/META-INF/services/hudson.Extension
        else
          echo "âŒ æ‰©å±•ç‚¹ç´¢å¼•æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: æ‰“åŒ…æµ‹è¯•
      run: mvn package -DskipTests
      
    - name: éªŒè¯æ’ä»¶å®Œæ•´æ€§
      run: |
        echo "æ£€æŸ¥ HPI æ–‡ä»¶..."
        if [ -f target/scheduled-build.hpi ]; then
          echo "âœ… æ’ä»¶æ–‡ä»¶: $(ls -lh target/scheduled-build.hpi | awk '{print $5}')"
          
          echo "æ£€æŸ¥ JAR å†…å®¹..."
          jar tf target/scheduled-build.jar | grep "hudson.Extension"
          
          echo "æ£€æŸ¥æ‰©å±•ç‚¹ç±»..."
          jar tf target/scheduled-build.jar | grep "ScheduledBuildAction\|ScheduledBuildManager\|ScheduledBuildProperty"
        else
          echo "âŒ æ’ä»¶æž„å»ºå¤±è´¥"
          exit 1
        fi
        
    - name: PR æ£€æŸ¥æ€»ç»“
      if: always()
      run: |
        echo "## ðŸ“Š PR æ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ä»£ç ç¼–è¯‘æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "âœ… æ’ä»¶æ‰“åŒ…æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "âœ… æ‰©å±•ç‚¹ç´¢å¼•éªŒè¯é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- æ’ä»¶æ–‡ä»¶: target/scheduled-build.hpi" >> $GITHUB_STEP_SUMMARY
        echo "- å¤§å°: $(ls -lh target/scheduled-build.hpi 2>/dev/null | awk '{print $5}' || echo 'æœªçŸ¥')" >> $GITHUB_STEP_SUMMARY

